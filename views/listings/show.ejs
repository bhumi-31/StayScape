<% layout("/layouts/boilerplate")%>

    <style>
        .show-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 0;
        }

        .listing-header {
            margin-bottom: 1.5rem;
        }

        .listing-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }

        .listing-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #6B7280;
            font-size: 0.95rem;
        }

        .listing-meta i {
            color: #FE424D;
        }

        .gallery-image {
            width: 100%;
            height: 60vh;
            object-fit: cover;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .listing-details {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .listing-info h4 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .host-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #E5E7EB;
        }

        .host-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FE424D 0%, #FF5A5F 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .description {
            color: #4B5563;
            line-height: 1.8;
            margin: 1.5rem 0;
        }

        .price-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 6rem;
        }

        .price-display {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1F2937;
        }

        .price-display span {
            font-size: 1rem;
            font-weight: 400;
            color: #6B7280;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn-edit {
            flex: 1;
            background: linear-gradient(135deg, #FE424D 0%, #FF5A5F 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.25s ease;
            text-align: center;
            text-decoration: none;
        }

        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(13, 148, 136, 0.3);
            color: white;
        }

        .btn-delete {
            background: #FEE2E2;
            color: #DC2626;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.15s ease;
        }

        .btn-delete:hover {
            background: #FECACA;
        }

        .review-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #E5E7EB;
        }

        .review-section h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .review-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.15s ease;
        }

        .review-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .review-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #6B7280;
        }

        .review-author {
            font-weight: 600;
            color: #1F2937;
        }

        .review-text {
            color: #4B5563;
            line-height: 1.6;
        }

        .map-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #E5E7EB;
        }

        .map-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        #map {
            width: 100%;
            height: 400px;
            border-radius: 1rem;
        }

        @media (max-width: 768px) {
            .listing-details {
                grid-template-columns: 1fr;
            }

            .price-card {
                position: static;
            }

            .gallery-image {
                height: 40vh;
            }
        }
    </style>

    <div class="show-container">
        <!-- Header -->
        <div class="listing-header">
            <h1>
                <%= listing.title %>
            </h1>
            <div class="listing-meta">
                <span><i class="fa-solid fa-location-dot"></i>
                    <%= listing.location %>, <%= listing.country %>
                </span>
            </div>
        </div>

        <!-- Gallery Images Carousel -->
        <% if (listing.images && listing.images.length> 0) { %>
            <!-- Multiple Images Carousel -->
            <div id="listingCarousel" class="carousel slide" data-bs-ride="carousel"
                style="border-radius: 1.5rem; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#listingCarousel" data-bs-slide-to="0"
                        class="active"></button>
                    <% for(let i=0; i < listing.images.length; i++) { %>
                        <button type="button" data-bs-target="#listingCarousel"
                            data-bs-slide-to="<%= i + 1 %>"></button>
                        <% } %>
                </div>
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="<%= listing.image.url %>" class="d-block w-100" alt="<%= listing.title %>"
                            style="height: 60vh; object-fit: cover;">
                    </div>
                    <% for(let img of listing.images) { %>
                        <div class="carousel-item">
                            <img src="<%= img.url %>" class="d-block w-100" alt="<%= listing.title %>"
                                style="height: 60vh; object-fit: cover;">
                        </div>
                        <% } %>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel"
                    data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel"
                    data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
            <!-- Image Thumbnails -->
            <div class="thumbnail-container"
                style="display: flex; gap: 0.5rem; margin-top: 1rem; overflow-x: auto; padding-bottom: 0.5rem;">
                <img src="<%= listing.image.url %>" alt="Thumbnail" class="thumbnail-img active"
                    style="width: 80px; height: 60px; object-fit: cover; border-radius: 0.5rem; cursor: pointer; border: 2px solid #FE424D;"
                    onclick="slideToImage(0, this)">
                <% for(let i=0; i < listing.images.length; i++) { %>
                    <img src="<%= listing.images[i].url %>" alt="Thumbnail" class="thumbnail-img"
                        style="width: 80px; height: 60px; object-fit: cover; border-radius: 0.5rem; cursor: pointer; border: 2px solid #E5E7EB;"
                        onclick="slideToImage(<%= i + 1 %>, this)">
                    <% } %>
            </div>

            <script>
                function slideToImage(index, clickedThumb) {
                    // Slide carousel to the selected image
                    const carousel = new bootstrap.Carousel(document.getElementById('listingCarousel'));
                    carousel.to(index);

                    // Update thumbnail borders
                    document.querySelectorAll('.thumbnail-img').forEach(thumb => {
                        thumb.style.border = '2px solid #E5E7EB';
                    });
                    clickedThumb.style.border = '2px solid #FE424D';
                }

                // Update thumbnail border when carousel slides
                document.getElementById('listingCarousel').addEventListener('slid.bs.carousel', function (e) {
                    const index = e.to;
                    const thumbnails = document.querySelectorAll('.thumbnail-img');
                    thumbnails.forEach((thumb, i) => {
                        thumb.style.border = i === index ? '2px solid #FE424D' : '2px solid #E5E7EB';
                    });
                });
            </script>
            <% } else { %>
                <!-- Single Image -->
                <img src="<%= listing.image.url %>" class="gallery-image" alt="<%= listing.title %>">
                <% } %>

                    <!-- Details Grid -->
                    <div class="listing-details">
                        <!-- Left Column - Info -->
                        <div class="listing-info">
                            <div class="host-info">
                                <div class="host-avatar">
                                    <%= listing.owner.username.charAt(0).toUpperCase() %>
                                </div>
                                <div>
                                    <h4>Hosted by <%= listing.owner.username %>
                                    </h4>
                                    <span style="color: #6B7280;">Verified Host</span>
                                </div>
                            </div>

                            <p class="description">
                                <%= listing.description %>
                            </p>

                            <% if (listing.amenities && listing.amenities.length> 0) { %>
                                <!-- Amenities Section - Airbnb Style -->
                                <div class="amenities-section-airbnb">
                                    <h4 class="amenities-title">What this place offers</h4>
                                    <div class="amenities-grid">
                                        <% const amenityIcons={ 'WiFi' : 'fa-wifi' , 'AC' : 'fa-snowflake'
                                            , 'Air conditioning' : 'fa-snowflake' , 'TV' : 'fa-tv' , 'Kitchen'
                                            : 'fa-utensils' , 'Washer' : 'fa-soap' , 'Washing machine' : 'fa-soap'
                                            , 'Parking' : 'fa-car' , 'Free parking on premises' : 'fa-car' , 'Pool'
                                            : 'fa-water-ladder' , 'Hot Tub' : 'fa-hot-tub-person' , 'Gym'
                                            : 'fa-dumbbell' , 'BBQ' : 'fa-fire-burner' , 'Fireplace' : 'fa-fire'
                                            , 'Balcony' : 'fa-building' , 'Garden' : 'fa-tree' , 'Beach Access'
                                            : 'fa-umbrella-beach' , 'Ski Access' : 'fa-person-skiing' , 'Pet Friendly'
                                            : 'fa-paw' , 'Smoking Allowed' : 'fa-smoking' , 'Workspace' : 'fa-laptop'
                                            , 'Dedicated workspace' : 'fa-laptop' , 'First Aid Kit' : 'fa-kit-medical'
                                            , 'Fire Extinguisher' : 'fa-fire-extinguisher' , 'Lift' : 'fa-elevator'
                                            , 'Exterior security cameras on property' : 'fa-video'
                                            , 'Carbon monoxide alarm' : 'fa-bell-slash' }; %>
                                            <% const displayAmenities=listing.amenities.slice(0, 10); %>
                                                <% for(let amenity of displayAmenities) { %>
                                                    <div class="amenity-item">
                                                        <i
                                                            class="fa-solid <%= amenityIcons[amenity] || 'fa-check' %>"></i>
                                                        <span>
                                                            <%= amenity %>
                                                        </span>
                                                    </div>
                                                    <% } %>
                                    </div>
                                    <% if (listing.amenities.length> 10) { %>
                                        <button type="button" class="show-all-amenities-btn"
                                            onclick="showAllAmenities()">
                                            Show all <%= listing.amenities.length %> amenities
                                        </button>
                                        <% } %>
                                </div>

                                <!-- All Amenities Modal -->
                                <div class="amenities-modal" id="amenitiesModal">
                                    <div class="amenities-modal-content">
                                        <div class="amenities-modal-header">
                                            <button type="button" class="amenities-modal-close"
                                                onclick="closeAmenitiesModal()">
                                                <i class="fa-solid fa-xmark"></i>
                                            </button>
                                            <h3>What this place offers</h3>
                                        </div>
                                        <div class="amenities-modal-body">
                                            <% for(let amenity of listing.amenities) { %>
                                                <div class="amenity-item-modal">
                                                    <i class="fa-solid <%= amenityIcons[amenity] || 'fa-check' %>"></i>
                                                    <span>
                                                        <%= amenity %>
                                                    </span>
                                                </div>
                                                <% } %>
                                        </div>
                                    </div>
                                </div>

                                <script>
                                    function showAllAmenities() {
                                        document.getElementById('amenitiesModal').classList.add('show');
                                        document.body.style.overflow = 'hidden';
                                    }
                                    function closeAmenitiesModal() {
                                        document.getElementById('amenitiesModal').classList.remove('show');
                                        document.body.style.overflow = 'auto';
                                    }
                                </script>
                                <% } %>
                        </div>

                        <!-- Right Column - Price Card -->
                        <div>
                            <div class="price-card">
                                <div class="price-display">
                                    &#8377;<%= listing.price.toLocaleString("en-IN") %> <span>/ night</span>
                                </div>

                                <% if(currUser) { %>
                                    <% let isInWishlist=false; if (currUser.wishlist) {
                                        isInWishlist=currUser.wishlist.some(id=>
                                        id.equals(listing._id));
                                        }
                                        %>
                                        <button class="btn-wishlist-show <%= isInWishlist ? 'active' : '' %>"
                                            data-listing-id="<%= listing._id %>"
                                            onclick="toggleWishlist(this, '<%= listing._id %>');">
                                            <i
                                                class="<%= isInWishlist ? 'fa-solid' : 'fa-regular' %> fa-heart me-2"></i>
                                            <span>
                                                <%= isInWishlist ? 'Saved' : 'Save to Wishlist' %>
                                            </span>
                                        </button>
                                        <% } %>

                                            <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
                                                <div class="action-buttons">
                                                    <a href="/listings/<%= listing._id %>/edit" class="btn-edit">
                                                        <i class="fa-solid fa-pen-to-square me-1"></i> Edit
                                                    </a>
                                                    <form method="POST"
                                                        action="/listings/<%= listing._id %>?_method=DELETE"
                                                        style="margin: 0;">
                                                        <button class="btn-delete" type="submit">
                                                            <i class="fa-solid fa-trash me-1"></i> Delete
                                                        </button>
                                                    </form>
                                                </div>
                                                <% } else if(currUser) { %>
                                                    <!-- Airbnb-style Booking Form -->
                                                    <div class="booking-form-airbnb">
                                                        <form action="/listings/<%= listing._id %>/book" method="POST"
                                                            id="bookingForm">
                                                            <!-- Date Picker Box -->
                                                            <div class="date-picker-box">
                                                                <div class="date-picker-row">
                                                                    <div class="date-input-group">
                                                                        <label>CHECK-IN</label>
                                                                        <input type="date" name="checkIn" id="checkIn"
                                                                            required
                                                                            min="<%= new Date().toISOString().split('T')[0] %>">
                                                                    </div>
                                                                    <div class="date-input-group">
                                                                        <label>CHECKOUT</label>
                                                                        <input type="date" name="checkOut" id="checkOut"
                                                                            required>
                                                                    </div>
                                                                </div>
                                                                <div class="guest-selector" id="guestSelector"
                                                                    onclick="toggleGuestDropdown()">
                                                                    <div class="guest-info">
                                                                        <label>GUESTS</label>
                                                                        <span id="guestSummary">1 guest</span>
                                                                    </div>
                                                                    <i class="fa-solid fa-chevron-down"
                                                                        id="guestChevron"></i>
                                                                </div>
                                                            </div>

                                                            <!-- Guest Dropdown -->
                                                            <div class="guest-dropdown" id="guestDropdown">
                                                                <!-- Adults -->
                                                                <div class="guest-row">
                                                                    <div class="guest-type">
                                                                        <span class="guest-label">Adults</span>
                                                                        <span class="guest-age">Age 13+</span>
                                                                    </div>
                                                                    <div class="guest-counter">
                                                                        <button type="button" class="counter-btn"
                                                                            onclick="decrementGuest('adults')"
                                                                            id="adults-minus">
                                                                            <i class="fa-solid fa-minus"></i>
                                                                        </button>
                                                                        <span id="adults-count">1</span>
                                                                        <button type="button" class="counter-btn"
                                                                            onclick="incrementGuest('adults')">
                                                                            <i class="fa-solid fa-plus"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <!-- Children -->
                                                                <div class="guest-row">
                                                                    <div class="guest-type">
                                                                        <span class="guest-label">Children</span>
                                                                        <span class="guest-age">Ages 2-12</span>
                                                                    </div>
                                                                    <div class="guest-counter">
                                                                        <button type="button" class="counter-btn"
                                                                            onclick="decrementGuest('children')"
                                                                            id="children-minus">
                                                                            <i class="fa-solid fa-minus"></i>
                                                                        </button>
                                                                        <span id="children-count">0</span>
                                                                        <button type="button" class="counter-btn"
                                                                            onclick="incrementGuest('children')">
                                                                            <i class="fa-solid fa-plus"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <!-- Infants -->
                                                                <div class="guest-row">
                                                                    <div class="guest-type">
                                                                        <span class="guest-label">Infants</span>
                                                                        <span class="guest-age">Under 2</span>
                                                                    </div>
                                                                    <div class="guest-counter">
                                                                        <button type="button" class="counter-btn"
                                                                            onclick="decrementGuest('infants')"
                                                                            id="infants-minus">
                                                                            <i class="fa-solid fa-minus"></i>
                                                                        </button>
                                                                        <span id="infants-count">0</span>
                                                                        <button type="button" class="counter-btn"
                                                                            onclick="incrementGuest('infants')">
                                                                            <i class="fa-solid fa-plus"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <!-- Pets -->
                                                                <div class="guest-row">
                                                                    <div class="guest-type">
                                                                        <span class="guest-label">Pets</span>
                                                                        <a href="#" class="service-animal-link"
                                                                            onclick="event.preventDefault(); openServiceAnimalModal();">Bringing
                                                                            a service animal?</a>
                                                                    </div>
                                                                    <div class="guest-counter">
                                                                        <button type="button" class="counter-btn"
                                                                            onclick="decrementGuest('pets')"
                                                                            id="pets-minus" disabled>
                                                                            <i class="fa-solid fa-minus"></i>
                                                                        </button>
                                                                        <span id="pets-count">0</span>
                                                                        <button type="button" class="counter-btn"
                                                                            onclick="incrementGuest('pets')"
                                                                            id="pets-plus" disabled>
                                                                            <i class="fa-solid fa-plus"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <p class="guest-info-text">This place has a maximum of
                                                                    10 guests, not including infants. Pets aren't
                                                                    allowed.</p>
                                                                <button type="button" class="close-dropdown-btn"
                                                                    onclick="closeGuestDropdown()">Close</button>
                                                            </div>

                                                            <!-- Hidden inputs for form submission -->
                                                            <input type="hidden" name="guests" id="totalGuests"
                                                                value="1">
                                                            <input type="hidden" name="adults" id="adultsInput"
                                                                value="1">
                                                            <input type="hidden" name="children" id="childrenInput"
                                                                value="0">
                                                            <input type="hidden" name="infants" id="infantsInput"
                                                                value="0">
                                                            <input type="hidden" name="pets" id="petsInput" value="0">

                                                            <!-- Price Display -->
                                                            <div class="price-header" id="priceHeader"
                                                                style="display: none;">
                                                                <span class="price-amount">&#8377;<span
                                                                        id="totalAmount">
                                                                        <%= listing.price.toLocaleString("en-IN") %>
                                                                    </span></span>
                                                                <span class="price-nights">for <span
                                                                        id="nightsText">1</span> night<span
                                                                        id="nightsPlural">s</span></span>
                                                            </div>

                                                            <button type="submit" class="reserve-btn">
                                                                Reserve
                                                            </button>
                                                            <p class="charge-notice">You won't be charged yet</p>
                                                        </form>
                                                    </div>

                                                    <!-- Service Animal Modal -->
                                                    <div class="service-animal-modal" id="serviceAnimalModal">
                                                        <div class="modal-content-animal">
                                                            <button type="button" class="modal-close-btn"
                                                                onclick="closeServiceAnimalModal()">
                                                                <i class="fa-solid fa-xmark"></i>
                                                            </button>
                                                            <div class="modal-image">
                                                                <img src="https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=600&h=400&fit=crop"
                                                                    alt="Service Animal">
                                                            </div>
                                                            <h3>Service animals</h3>
                                                            <p>Service animals aren't pets, so there's no need to add
                                                                them here.</p>
                                                            <p class="modal-link-text">Travelling with an emotional
                                                                support animal? Check out our <a href="#">accessibility
                                                                    policy</a>.</p>
                                                        </div>
                                                    </div>

                                                    <script>
                                                        const pricePerNight = <%= listing.price %>;
                                                        const checkInInput = document.getElementById('checkIn');
                                                        const checkOutInput = document.getElementById('checkOut');

                                                        // Guest counts
                                                        let guests = { adults: 1, children: 0, infants: 0, pets: 0 };
                                                        const maxGuests = 10;

                                                        function toggleGuestDropdown() {
                                                            const dropdown = document.getElementById('guestDropdown');
                                                            const chevron = document.getElementById('guestChevron');
                                                            dropdown.classList.toggle('show');
                                                            chevron.classList.toggle('rotated');
                                                        }

                                                        function closeGuestDropdown() {
                                                            const dropdown = document.getElementById('guestDropdown');
                                                            const chevron = document.getElementById('guestChevron');
                                                            dropdown.classList.remove('show');
                                                            chevron.classList.remove('rotated');
                                                        }

                                                        function updateGuestSummary() {
                                                            const total = guests.adults + guests.children;
                                                            let summary = total + ' guest' + (total !== 1 ? 's' : '');
                                                            if (guests.infants > 0) {
                                                                summary += ', ' + guests.infants + ' infant' + (guests.infants !== 1 ? 's' : '');
                                                            }
                                                            if (guests.pets > 0) {
                                                                summary += ', ' + guests.pets + ' pet' + (guests.pets !== 1 ? 's' : '');
                                                            }
                                                            document.getElementById('guestSummary').textContent = summary;

                                                            // Update hidden inputs
                                                            document.getElementById('totalGuests').value = total;
                                                            document.getElementById('adultsInput').value = guests.adults;
                                                            document.getElementById('childrenInput').value = guests.children;
                                                            document.getElementById('infantsInput').value = guests.infants;
                                                            document.getElementById('petsInput').value = guests.pets;

                                                            // Update button states
                                                            document.getElementById('adults-minus').disabled = guests.adults <= 1;
                                                            document.getElementById('children-minus').disabled = guests.children <= 0;
                                                            document.getElementById('infants-minus').disabled = guests.infants <= 0;
                                                            document.getElementById('pets-minus').disabled = guests.pets <= 0;
                                                        }

                                                        function incrementGuest(type) {
                                                            const currentTotal = guests.adults + guests.children;
                                                            if (type !== 'infants' && type !== 'pets' && currentTotal >= maxGuests) return;
                                                            guests[type]++;
                                                            document.getElementById(type + '-count').textContent = guests[type];
                                                            updateGuestSummary();
                                                        }

                                                        function decrementGuest(type) {
                                                            if (type === 'adults' && guests.adults <= 1) return;
                                                            if (guests[type] <= 0) return;
                                                            guests[type]--;
                                                            document.getElementById(type + '-count').textContent = guests[type];
                                                            updateGuestSummary();
                                                        }

                                                        function openServiceAnimalModal() {
                                                            document.getElementById('serviceAnimalModal').classList.add('show');
                                                            document.body.style.overflow = 'hidden';
                                                        }

                                                        function closeServiceAnimalModal() {
                                                            document.getElementById('serviceAnimalModal').classList.remove('show');
                                                            document.body.style.overflow = 'auto';
                                                        }

                                                        function calculatePrice() {
                                                            const checkIn = new Date(checkInInput.value);
                                                            const checkOut = new Date(checkOutInput.value);
                                                            const priceHeader = document.getElementById('priceHeader');

                                                            if (checkIn && checkOut && checkOut > checkIn) {
                                                                const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                                                                const total = pricePerNight * nights;

                                                                document.getElementById('totalAmount').textContent = total.toLocaleString('en-IN');
                                                                document.getElementById('nightsText').textContent = nights;
                                                                document.getElementById('nightsPlural').textContent = nights === 1 ? '' : 's';
                                                                priceHeader.style.display = 'block';
                                                            } else {
                                                                priceHeader.style.display = 'none';
                                                            }
                                                        }

                                                        checkInInput.addEventListener('change', function () {
                                                            if (this.value) {
                                                                const checkIn = new Date(this.value);
                                                                checkIn.setDate(checkIn.getDate() + 1);
                                                                checkOutInput.min = checkIn.toISOString().split('T')[0];
                                                            }
                                                            calculatePrice();
                                                        });

                                                        checkOutInput.addEventListener('change', calculatePrice);

                                                        // Close dropdown when clicking outside
                                                        document.addEventListener('click', function (e) {
                                                            const dropdown = document.getElementById('guestDropdown');
                                                            const selector = document.getElementById('guestSelector');
                                                            if (!dropdown.contains(e.target) && !selector.contains(e.target)) {
                                                                closeGuestDropdown();
                                                            }
                                                        });

                                                        // Initialize button states
                                                        updateGuestSummary();
                                                    </script>
                                                    <% } else { %>
                                                        <!-- Login prompt for non-logged in users -->
                                                        <div
                                                            style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #E5E7EB; text-align: center;">
                                                            <p style="color: #6B7280; margin-bottom: 1rem;">Log in to
                                                                book this stay
                                                            </p>
                                                            <a href="/login" class="btn-edit"
                                                                style="display: inline-block;">
                                                                <i class="fa-solid fa-right-to-bracket me-2"></i>Log In
                                                            </a>
                                                        </div>
                                                        <% } %>
                            </div>
                        </div>
                    </div>

                    <!-- Review Section -->
                    <div class="review-section">
                        <% if(currUser) { %>
                            <h3><i class="fa-solid fa-star me-2" style="color: #F59E0B;"></i>Leave a Review</h3>
                            <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate
                                class="needs-validation" style="max-width: 600px;">
                                <div class="mb-3">
                                    <label for="rating" class="form-label">Rating</label>
                                    <fieldset class="starability-slot">
                                        <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]"
                                            value="1" checked aria-label="No rating." />
                                        <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                                        <label for="first-rate1" title="Terrible">1 star</label>
                                        <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                                        <label for="first-rate2" title="Not good">2 stars</label>
                                        <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                                        <label for="first-rate3" title="Average">3 stars</label>
                                        <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                                        <label for="first-rate4" title="Very good">4 stars</label>
                                        <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                                        <label for="first-rate5" title="Amazing">5 stars</label>
                                    </fieldset>
                                </div>

                                <div class="mb-3">
                                    <label for="comment" class="form-label">Your Review</label>
                                    <textarea name="review[comment]" id="comment" cols="30" rows="4"
                                        class="form-control" placeholder="Share your experience..." required></textarea>
                                    <div class="invalid-feedback">Please add some comments for review</div>
                                </div>
                                <button class="btn-edit" type="submit" style="width: auto;">
                                    <i class="fa-solid fa-paper-plane me-1"></i> Submit Review
                                </button>
                            </form>
                            <% } %>

                                <% if (listing.reviews.length> 0) { %>
                                    <h3 style="margin-top: 2rem;"><i class="fa-solid fa-comments me-2"
                                            style="color: #FE424D;"></i>All Reviews (<%= listing.reviews.length %>)</h3>
                                    <div class="row">
                                        <% for(let review of listing.reviews) { %>
                                            <div class="col-md-6">
                                                <div class="review-card">
                                                    <div class="review-header">
                                                        <div class="review-avatar">
                                                            <%= review.author.username.charAt(0).toUpperCase() %>
                                                        </div>
                                                        <div>
                                                            <div class="review-author">@<%= review.author.username %>
                                                            </div>
                                                            <p class="starability-result mb-0"
                                                                data-rating="<%= review.rating %>">
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <p class="review-text">
                                                        <%= review.comment %>
                                                    </p>
                                                    <% if(currUser && review.author._id.equals(currUser._id)) { %>
                                                        <form
                                                            action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                                                            method="POST">
                                                            <button class="btn btn-sm"
                                                                style="background: #FEE2E2; color: #DC2626;">
                                                                <i class="fa-solid fa-trash"></i> Delete
                                                            </button>
                                                        </form>
                                                        <% } %>
                                                </div>
                                            </div>
                                            <% } %>
                                    </div>
                                    <% } %>
                    </div>

                    <!-- Map Section -->
                    <div class="map-section">
                        <h3><i class="fa-solid fa-map-location-dot me-2" style="color: #FE424D;"></i>Where you'll be
                        </h3>
                        <div id="map"></div>
                    </div>
    </div>

    <script>
        const mapToken = "<%= mapToken.trim() %>";
        const listing = <%- JSON.stringify(listing) %>;
    </script>
    <script src="/js/map.js"></script>
    <script src="/js/wishlist.js"></script>